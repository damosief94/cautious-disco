name: Ultimate-Win-Ngrok-RDP-Fixed

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Update Password & Configure User
        shell: pwsh
        run: |
          # 1. ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¦Ù‡
          net user runneradmin Passw0rd1234
          
          # 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… PowerShell Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† WMIC Ù„Ù…Ù†Ø¹ Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
          Set-LocalUser -Name "runneradmin" -PasswordNeverExpires $true
          
          Write-Host "âœ… User configured successfully."

      - name: Download and Install Ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "."
          
      - name: Connect to Ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
          # ÙØªØ­ Ø§Ù„Ù†ÙÙ‚ Ù„Ù„Ù€ RDP
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389"

      - name: Get RDP Connection Info
        shell: pwsh
        run: |
          Start-Sleep -Seconds 10
          try {
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $publicUrl = $tunnels.tunnels[0].public_url
            $cleanUrl = $publicUrl -replace "tcp://", ""
            
            Write-Host "======================================================"
            Write-Host "âœ… RDP is Ready!"
            Write-Host "ğŸ” User: runneradmin"
            Write-Host "ğŸ”‘ Pass: Passw0rd1234"
            Write-Host "ğŸŒ Address: $cleanUrl"
            Write-Host "======================================================"
          }
          catch {
            Write-Host "âŒ Error getting Ngrok URL. Check if Token is correct."
          }

      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ”„ Loop started... Session will stay alive for 6 hours."
          $i = 0
          while ($i -lt 21600) { 
            Start-Sleep -Seconds 60 
            $i += 60
            # Ø·Ø¨Ø§Ø¹Ø© Ù†Ù‚Ø·Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù…Ù†Ø¹ ØªÙˆÙ‚Ù Ø§Ù„Ù€ Log
            Write-Host -NoNewline "."
          }
