name: Ultimate-Win-Ngrok-V3-Fixed

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Update Password & Configure User
        shell: pwsh
        run: |
          net user runneradmin Passw0rd1234
          Set-LocalUser -Name "runneradmin" -PasswordNeverExpires $true
          Write-Host "âœ… User configured successfully."

      - name: Download and Install Ngrok V3 (LATEST)
        shell: pwsh
        run: |
          # ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© V3 Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "."

      - name: Connect to Ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
          # ØªØ´ØºÙŠÙ„ Ngrok Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --region us --log=ngrok.log"

      - name: Get RDP Connection Info
        shell: pwsh
        run: |
          Write-Host "â³ Waiting for Ngrok tunnel to initialize..."
          Start-Sleep -Seconds 10
          
          try {
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $publicUrl = $tunnels.tunnels[0].public_url
            
            if (-not $publicUrl) {
                throw "No URL found."
            }

            $cleanUrl = $publicUrl -replace "tcp://", ""
            
            Write-Host "======================================================"
            Write-Host "âœ… RDP is Ready!"
            Write-Host "ğŸ” User: runneradmin"
            Write-Host "ğŸ”‘ Pass: Passw0rd1234"
            Write-Host "ğŸŒ Address: $cleanUrl"
            Write-Host "======================================================"
          }
          catch {
            Write-Host "âŒ Error getting Ngrok URL. Printing Logs:"
            if (Test-Path "ngrok.log") { Get-Content "ngrok.log" }
            exit 1
          }

      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "ğŸ”„ Loop started... Session will stay alive for 6 hours."
          $i = 0
          while ($i -lt 21600) { 
            Start-Sleep -Seconds 60 
            $i += 60
            Write-Host -NoNewline "."
          }
