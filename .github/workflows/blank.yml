name: Ultimate-Win-Ngrok-Debug

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Update Password & Configure User
        shell: pwsh
        run: |
          net user runneradmin Passw0rd1234
          Set-LocalUser -Name "runneradmin" -PasswordNeverExpires $true
          Write-Host "‚úÖ User configured successfully."

      - name: Download and Install Ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "."

      - name: Connect to Ngrok (With Logging)
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
          # ÿ™ÿ¥ÿ∫ŸäŸÑ Ngrok ŸÖÿπ ÿ≠ŸÅÿ∏ ŸÖŸÑŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ (Log) ŸÑŸÖÿπÿ±ŸÅÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --region us --log=ngrok.log"

      - name: Get RDP Connection Info
        shell: pwsh
        run: |
          Write-Host "‚è≥ Waiting for Ngrok tunnel to initialize..."
          Start-Sleep -Seconds 15
          
          try {
            $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $publicUrl = $tunnels.tunnels[0].public_url
            
            if (-not $publicUrl) {
                throw "No URL found in API response."
            }

            $cleanUrl = $publicUrl -replace "tcp://", ""
            
            Write-Host "======================================================"
            Write-Host "‚úÖ RDP is Ready!"
            Write-Host "üîê User: runneradmin"
            Write-Host "üîë Pass: Passw0rd1234"
            Write-Host "üåç Address: $cleanUrl"
            Write-Host "======================================================"
          }
          catch {
            Write-Host "‚ùå Error getting Ngrok URL. Printing Logs:"
            Write-Host "----------------------------------------"
            # ÿ∑ÿ®ÿßÿπÿ© ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿ∑ÿ£ ŸÖŸÜ ŸÖŸÑŸÅ ÿßŸÑÿ≥ÿ¨ŸÑ
            if (Test-Path "ngrok.log") {
                Get-Content "ngrok.log"
            } else {
                Write-Host "No log file found. Ngrok failed to start completely."
            }
            Write-Host "----------------------------------------"
            exit 1
          }

      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "üîÑ Loop started... Session will stay alive for 6 hours."
          $i = 0
          while ($i -lt 21600) { 
            Start-Sleep -Seconds 60 
            $i += 60
            Write-Host -NoNewline "."
          }
