name: Ultimate-Win-Ngrok-RDP

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Set Password for User (Admin)
        shell: pwsh
        run: |
          # Ù‡Ù†Ø§ ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Runneradmin
          # ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Passw0rd1234 Ù„Ø£ÙŠ Ø´ÙŠØ¡ ØªØ±ÙŠØ¯Ù‡
          net user runneradmin Passw0rd1234 /add
          net localgroup administrators runneradmin /add
          cmd /c "wmic useraccount where name='runneradmin' set PasswordExpires=FALSE"

      - name: Download and Install Ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive -Path "ngrok.zip" -DestinationPath "."
          
      - name: Connect to Ngrok
        shell: pwsh
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
          # ÙØªØ­ Ø¨ÙˆØ±Øª 3389 Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ RDP
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389"

      - name: Get RDP Connection Info
        shell: pwsh
        run: |
          Start-Sleep -Seconds 10
          $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
          $publicUrl = $tunnels.tunnels[0].public_url
          # Ø¥Ø²Ø§Ù„Ø© //:tcp Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØµØ¨Ø­ Ø¬Ø§Ù‡Ø²Ø§Ù‹
          $cleanUrl = $publicUrl -replace "tcp://", ""
          
          Write-Host "======================================================"
          Write-Host "âœ… RDP is Ready!"
          Write-Host "ğŸ” User: runneradmin"
          Write-Host "ğŸ”‘ Pass: Passw0rd1234"
          Write-Host "ğŸŒ Address: $cleanUrl"
          Write-Host "======================================================"

      - name: Prevent Sleep / Keep Alive
        shell: pwsh
        run: |
          # Ø­Ù„Ù‚Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù…Ø¯Ø© 6 Ø³Ø§Ø¹Ø§Øª
          $i = 0
          while ($i -lt 21600) { 
            Start-Sleep -Seconds 60 
            $i += 60
            # ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ù„Ù„ÙØ£Ø±Ø© Ø£Ùˆ Ù†Ø´Ø§Ø· ÙˆÙ‡Ù…ÙŠ Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            [Console]::Title = "RDP Running - Time elapsed: $i seconds"
          }
